# 云服务

我需要一个免费的服务器和域名，网上搜索了一下，总结出来以下几个方案：

## 云服务器

### Oracle Cloud

注册即送$300点，30天到期后可以转换到 Always Free 服务，即永久免费。

- 2个 AMD VM或者 4 个 ARM VM
- 200G存储
- 10T/月 流量

地址：https://www.oracle.com/cloud/free/

实用型很强，完全满足我们跑jenkins的需求。推荐。

经过测试，注册需要国际信用卡，暂时没有。

### AWS 免费套餐 (12个月)

- EC2 t2.micro (1核 1GB)
- 750 小时/月（基本全天运行）
- 30GB 存储

地址：https://aws.amazon.com/free/

只有12个月的免费套餐，到期后需要收费，不太推荐。

经过测试，需要验证严格的个人信息，有虚拟卡也不够用，还要美国手机号的验证码。


### Google Cloud Platform

- $300 免费额度
- 90 天试用

地址：https://cloud.google.com/free

谷歌云免费的产品全部需要支付认证，并且无法使用虚拟卡，国内的万事卡和visa卡认证会失败。暂时放弃谷歌云。

### 总结

缺少服务器，暂时没法部署自己的服务。

#### 2025/12/11 更新

介于以上种种问题，所以自己买个阿里云的服务器，然后自己部署。

自动化部署脚本步骤和方案：

1. 服务器初始化脚本 - 安装 Docker、Jenkins、Nginx
2. Jenkins 配置脚本 - Pipeline、构建任务
3. 自动备份脚本 - 定期备份构建产物

## 免费域名

有自己的服务器后，还有一个问题没有解决，那就是需要一个域名进行访问。

### Freenom

- 免费顶级域名：.tk, .ml, .ga, .cf, .gq
- 可免费使用 12 个月（可续期）
- 示例：myjenkins.tk

地址：https://www.freenom.com

### 子域名服务

DuckDNS 

地址：https://www.duckdns.org

No-IP

地址：https://www.noip.com

### Cloud Provider 提供的免费域名

Vercel/Netlify为代表的云服务器商

### 便宜的域名对比

| 域名商 | .com 首年 | .xyz 首年 | 特点 |
|--------|-----------|-----------|------|
| Namecheap | ~$9 | ~$1 | 性价比高，送隐私保护 |
| Cloudflare | ~$9 | ~$1 | 最便宜，按成本价 |
| Porkbun | ~$9 | ~$1 | 简单易用 |
| 阿里云 | ¥55 | ¥8 | 国内快，需备案 |
| 腾讯云 | ¥45 | ¥8 | 新人优惠 |

## 总结

经过上面的数据，总结出几套组合方案

### 方案A

因为我之前使用过Vercel的免费域名，所以这次优先考虑vercel的免费域名。

但因为Vercel没有传统意义上的免费服务器，更偏向于静态网站部署，不能跑Jenkins这种长期运行的服务。

折中方案是Vercel + Oracle Cloud组合

```bash
# 架构
┌─────────────────┐
│  Vercel (前端)   │  ← 用户访问
│  yourapp.vercel.app │
└────────┬────────┘
         │ API 调用
         ↓
┌─────────────────┐
│ Oracle Cloud    │  ← Jenkins + 后端服务
│ (免费服务器)     │
│ api.yourdomain.com │
└─────────────────┘
```

### 方案B

```bash
服务器: Oracle Cloud (免费)
域名: DuckDNS (免费)
SSL: Let's Encrypt (免费)
CDN: Cloudflare (免费)
```

最终访问地址: https://myjenkins.duckdns.org

### 方案C

```bash
服务器: Oracle Cloud (免费)
域名: Cloudflare 购买 .xyz ($1/年)
DNS: Cloudflare (免费)
SSL: Cloudflare SSL (免费)
CDN: Cloudflare CDN (免费)
```

最终访问地址: https://jenkins.yourname.xyz

### 最终方案D

由于国外的服务器没法购买，就买了阿里云的服务器顺带域名。

之前的h5托管在Vercel，博客在Github page上，所以开始逐步转移。

目前正在忙实名认证还是备案的事情，估计需要半个月多吧。

## 服务器部署工作

备案一周搞定了，接下来就开始部署我们的服务器。

### 服务器和域名

我们需要登录阿里云控制台，搜索“云解析DNS”，找到我们的域名并点击“解析设置”，将记录值改完我们购买的ECS服务器的公网IP地址。

此时我们的网站“hongyingxin.com”还是无法访问，因为我们的服务器还没有配置好。

通过“Workbench”连接上服务器，因为提供了“AI Agent”助手，对新手比较友善，我们可以通过对话就完成软件的安装。

### 安装nginx

nginx是一个轻量级的Web服务器，我们通过“AI Agent”助手安装nginx，并配置好我们的网站。

首先检查系统是否已经安装了nginx，如果没有安装，则安装nginx。

>备注：系统是Alibaba Cloud Linux，dnf是系用的包管理器，宝塔是可视化图形管理界面

```bash
# 检查系统是否已经安装了nginx
sudo dnf list installed nginx
# 检查系统是否已经安装了nginx的包
sudo dnf list nginx
# 安装
sudo dnf -y install nginx
# 启动nginx服务并设置为开机自启
sudo systemctl start nginx
sudo systemctl enable nginx

# 常用的一些命令
# 重启nginx服务
sudo systemctl restart nginx
# 停止nginx服务
sudo systemctl stop nginx
# 查看nginx服务状态
sudo systemctl status nginx
# 查看nginx服务日志
sudo systemctl logs nginx
# 查看nginx服务配置
sudo systemctl config nginx
```

此时就可以正常访问到我们的网站了。

然后通过命令`which nginx`找到nginx的安装目录。Nginx的可执行文件位于`/usr/sbin/nginx`。这是Nginx的主程序路径。Nginx的配置文件会位于 `/etc/nginx/nginx.conf`。

通过`cat /etc/nginx/nginx.conf`查看nginx的配置文件。

### 初始化页面

接下来我们在ECS服务器根目录创建一个`web`目录，并在这个目录下创建一个`index.html`文件，内容为：

```html
<html>
  <head>
    <title>Welcome to nginx!</title>
  </head>
    <body>
    <h1>Welcome to nginx!</h1>
  </body>
</html>
```

然后修改nginx的配置文件，将网站的根目录指向`/web`，并设置默认文件为`index.html`。

修改内容如下：

1. 默认根目录更改:

  - 原始配置: root /usr/share/nginx/html;
  - 修改后: root /web;

2. 注释部分的根目录也同步更新:

  - 原始配置: # root /usr/share/nginx/html;
  - 修改后: # root /web;

### 宝塔

宝塔面板是一款非常流行的服务器管理工具，可以提供可视化图形管理界面，方便我们管理服务器。

```bash

sudo yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sudo bash install.sh
```

安装完成后，会显示“面板地址”、“username(帐号)”、“password(密码)”，我们可以使用这些信息登录宝塔面板。

因为宝塔默认使用8888端口，阿里云的防火墙（安全组）默认是关闭的，所以需要手动开启。

步骤如下：

- 阿里云ECS控制台
- 点击左侧“安全组” -> 点击列表里的安全组ID -> “手动添加”
- 添加规则，类型为“HTTP”，源地址为“0.0.0.0/0”，端口范围为“8888”

### SSL证书

我们的域名是http协议，需要升级到https协议。

阿里云有提供免费的证书，虽然只有三个月的免费期，但是已经足够我们使用了。后面可以根据需要选择使用宝塔自带的证书，支持自动续签功能。

参考文档：https://help.aliyun.com/zh/ssl-certificate/product-overview/get-started-with-free-certificates

#### 注意点

在配置nginx https协议时遇到很多问题，首先就是证书路径指向问题。

**文件路径问题**

路径需要完整的文件路径，所以最好使用` find / -name "hongyingxin.com.pem"`找出对应的路径关系

**防火墙问题**

nginx配置好后，需要到阿里云ECS控制台开启443端口访问权限，不然配置就算对了也无法访问。

需要善于使用命令，如
- 使用`nginx -t`排查语法问题
- 修改配置文件后需要重启服务`sudo systemctl restart nginx`。
- 使用`curl`测试请求协议问题，因为我们设置了http重定向到https，所以需要排查出是哪一个协议有问题。

这次的问题，通过curl测试后发现http配置正常，返回301，而https请求失败，所以将问题定位到防火墙配置问题上才得以解决问题。

### docker容器

因为需要部署`Jenkins`，`MySQL`，`Redis`等服务，为了解决不同环境的问题，所以需要使用`docker`容器来部署。

首先需要在我们的服务器上安装`Docker`。

```bash
# 安装docker
sudo yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 启动并开机自启
sudo systemctl start docker
sudo systemctl enable docker
```

安装好之后，还需要配置docker的镜像源。阿里云这些都有免费的提供。

步骤：阿里云控制台 -> 容器镜像服务 -> 镜像工具 -> 镜像加速器 -> 加速器地址 -> 复制 

然后在外面的服务器，将上面得到的地址写入Docker的配置文件。

- 创建/编辑配置文件

```bash
sudo mkdir -p /etc/docker
sudo vim /etc/docker/daemon.json
```

- 按`i`进入`vim`编辑模式，粘贴一下内容，并替换阿里云加速地址

```json
{
  "registry-mirrors": ["https://你的阿里云加速地址"]
}
```

- 按`Esc`退出编辑模式，输入`:wq`保存并退出（这里建议直接cv，配置文件必须是双引号）

- 重启Docker让配置生效

```bash
sudo systemctl daemon-reload
sudo systemctl restart docker
```

至此，我们的Docker配置就完成了。

### Jenkins

首先我们需要创建数据目录，给Jenkins准备一个“家”。

```bash
# 创建目录
mkdir -p /data/jenkins_home

# 修改权限 (Jenkins 容器内部默认使用 uid 1000，需要把这个文件夹权限给它，否则启动会报错)
chown -R 1000:1000 /data/jenkins_home
```

然后安装并启动Jenkins

```bash
docker run -d \
  --name jenkins \
  --restart always \
  -p 8080:8080 \
  -p 50000:50000 \
  -v /data/jenkins_home:/var/jenkins_home \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /usr/bin/docker:/usr/bin/docker \
  --env JAVA_OPTS="-Xmx1024m" \
  jenkins/jenkins:lts
```

**命令解析**

- -p 8080:8080: 将服务器的 8080 端口映射给 Jenkins。

- -v ...: 把刚才创建的目录挂载进去。

- JAVA_OPTS: 关键！ 限制 Jenkins 最大使用 1G 内存。

#### 设置安全组

因为Jenkins默认跑在8080端口，和之前配置https 443 一样，需要去阿里云控制台设置放行。

阿里云控制台 -> 安全组 -> 手动添加 -> 端口范围 8080

#### 初始化Jenkins

打开浏览器，输入`http://你的服务器公网IP:8080`，进入Jenkins初始化页面。

回到服务器，输入`docker ps`查看Jenkins容器是否启动成功。

获取密码，输入`docker logs jenkins`查看日志，找到密码。

然后接下来的流程就和本地安装Jenkins一样了。

#### 遇到的坑

##### jenkins版本过老的问题

使用了阿里云提供的加速器镜像，但下载的jenkins版本太老了，2.319.1版本是几年前的版本，导致很多插件都无法安装。后面又重新拉去lts，导致docker容器比较混乱而且问题还没解决。于是开始解决版本过老的问题。

###### 清理容器

**查看jenkins**

```bash
sudo docker ps -a | grep jenkins
```

**强制删除jenkins**

```bash
sudo docker rm -f jenkins
```

###### 清理镜像

**强制删除镜像**
```bash
sudo docker rmi -f jenkins/jenkins:lts
```

**验证镜像是否删除**
```bash
sudo docker images | grep jenkins
```

###### 清理残留数据

因为之前运行的是旧版本，初始化生成的数据文件格式太老，所以也要清空一下。

```bash
sudo rm -rf /data/jenkins_home
sudo mkdir -p /data/jenkins_home
sudo chown -R 1000:1000 /data/jenkins_home
```

###### 拉取最新版本

**重新拉取最新镜像**

```bash
sudo docker pull jenkins/jenkins:lts
```

**检查版本**
```bash
sudo docker inspect jenkins/jenkins:lts | grep JENKINS_VERSION
```

###### 镜像问题

尽管我使用了`lts`去拉取，但还是报错了。所以干脆放弃阿里云提供的镜像加速器，使用第三方代理镜像源。

1. 使用国内代理地址拉取

不要直接拉`jenkins/jenkins`，我们在前面加上代理前缀 `docker.m.daocloud.io`。

```bash
sudo docker pull docker.m.daocloud.io/jenkins/jenkins:2.479.2
```

2. 给镜像改名

下载下来后，镜像的名字会很长，需要把它改回标准名字。

```bash
sudo docker tag docker.m.daocloud.io/jenkins/jenkins:2.479.2 jenkins/jenkins:2.479.2
```

3. 验证版本

```bash
sudo docker inspect jenkins/jenkins:2.479.2 | grep JENKINS_VERSION
```

到这里我们就能看到`2.479.2`版本号了。

4. 启动新容器

```bash
sudo docker run -d \
  --name jenkins \
  --restart always \
  -p 8080:8080 \
  -p 50000:50000 \
  -v /data/jenkins_home:/var/jenkins_home \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /usr/bin/docker:/usr/bin/docker \
  --env JAVA_OPTS="-Xmx1024m" \
  jenkins/jenkins:2.479.2
```