# 服务器部署工作

备案一周搞定了，接下来就开始部署我们的服务器。

## 服务器和域名

我们需要登录阿里云控制台，搜索“云解析DNS”，找到我们的域名并点击“解析设置”，将记录值改为我们购买的 ECS 服务器的公网 IP 地址。

此时我们的网站“hongyingxin.com”还是无法访问，因为我们的服务器还没有配置好。

通过“Workbench”连接上服务器，因为提供了“AI Agent”助手，对新手比较友善，我们可以通过对话就完成软件的安装。

## 安装 Nginx

Nginx 是一个轻量级的 Web 服务器，我们通过“AI Agent”助手安装 Nginx，并配置好我们的网站。

首先检查系统是否已经安装了 Nginx，如果没有安装，则安装 Nginx。

> 备注：系统是 Alibaba Cloud Linux，dnf 是系统的包管理器，宝塔是可视化图形管理界面

```bash
# 检查系统是否已经安装了nginx
sudo dnf list installed nginx
# 检查系统是否已经安装了nginx的包
sudo dnf list nginx
# 安装
sudo dnf -y install nginx
# 启动nginx服务并设置为开机自启
sudo systemctl start nginx
sudo systemctl enable nginx

# 常用的一些命令
# 重启nginx服务
sudo systemctl restart nginx
# 停止nginx服务
sudo systemctl stop nginx
# 查看nginx服务状态
sudo systemctl status nginx
# 查看nginx服务日志
sudo systemctl logs nginx
# 查看nginx服务配置
sudo systemctl config nginx
```

此时就可以正常访问到我们的网站了。

然后通过命令 `which nginx` 找到 Nginx 的安装目录。Nginx 的可执行文件位于 `/usr/sbin/nginx`。这是 Nginx 的主程序路径。Nginx 的配置文件会位于 `/etc/nginx/nginx.conf`。

通过 `cat /etc/nginx/nginx.conf` 查看 Nginx 的配置文件。

## 初始化页面

接下来我们在 ECS 服务器根目录创建一个 `web` 目录，并在这个目录下创建一个 `index.html` 文件，内容为：

```html
<html>
  <head>
    <title>Welcome to nginx!</title>
  </head>
    <body>
    <h1>Welcome to nginx!</h1>
  </body>
</html>
```

然后修改 Nginx 的配置文件，将网站的根目录指向 `/web`，并设置默认文件为 `index.html`。

修改内容如下：

1. 默认根目录更改:

  - 原始配置: root /usr/share/nginx/html;
  - 修改后: root /web;

2. 注释部分的根目录也同步更新:

  - 原始配置: # root /usr/share/nginx/html;
  - 修改后: # root /web;

## 宝塔

宝塔面板是一款非常流行的服务器管理工具，可以提供可视化图形管理界面，方便我们管理服务器。

```bash

sudo yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sudo bash install.sh
```

安装完成后，会显示“面板地址”、“username(帐号)”、“password(密码)”，我们可以使用这些信息登录宝塔面板。

因为宝塔默认使用8888端口，阿里云的防火墙（安全组）默认是关闭的，所以需要手动开启。

步骤如下：

- 阿里云ECS控制台
- 点击左侧“安全组” -> 点击列表里的安全组ID -> “手动添加”
- 添加规则，类型为“HTTP”，源地址为“0.0.0.0/0”，端口范围为“8888”

## SSL 证书

我们的域名是 http 协议，需要升级到 https 协议。

阿里云有提供免费的证书，虽然只有三个月的免费期，但是已经足够我们使用了。后面可以根据需要选择使用宝塔自带的证书，支持自动续签功能。

参考文档：https://help.aliyun.com/zh/ssl-certificate/product-overview/get-started-with-free-certificates

### 注意点

在配置 Nginx https 协议时遇到很多问题，首先就是证书路径指向问题。

**文件路径问题**

路径需要完整的文件路径，所以最好使用 `find / -name "hongyingxin.com.pem"` 找出对应的路径关系。

**防火墙问题**

Nginx 配置好后，需要到阿里云 ECS 控制台开启 443 端口访问权限，不然配置就算对了也无法访问。

需要善于使用命令，如：
- 使用 `nginx -t` 排查语法问题。
- 修改配置文件后需要重启服务 `sudo systemctl restart nginx`。
- 使用 `curl` 测试请求协议问题，因为我们设置了 http 重定向到 https，所以需要排查出是哪一个协议有问题。

这次的问题，通过 curl 测试后发现 http 配置正常，返回 301，而 https 请求失败，所以将问题定位到防火墙配置问题上才得以解决问题。

## Docker 容器

因为需要部署 `Jenkins`，`MySQL`，`Redis`等服务，为了解决不同环境的问题，所以需要使用 `Docker` 容器来部署。

首先需要在我们的服务器上安装 `Docker`。

```bash
# 安装 docker
sudo yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 启动并开机自启
sudo systemctl start docker
sudo systemctl enable docker
```

安装好之后，还需要配置 Docker 的镜像源。阿里云这些都有免费的提供。

步骤：阿里云控制台 -> 容器镜像服务 -> 镜像工具 -> 镜像加速器 -> 加速器地址 -> 复制 

然后我们的服务器上，将上面得到的地址写入 Docker 的配置文件。

- 创建/编辑配置文件

```bash
sudo mkdir -p /etc/docker
sudo vim /etc/docker/daemon.json
```

- 按 `i` 进入 `vim` 编辑模式，粘贴以下内容，并替换阿里云加速地址

```json
{
  "registry-mirrors": ["https://你的阿里云加速地址"]
}
```

- 按 `Esc` 退出编辑模式，输入 `:wq` 保存并退出（这里建议直接复制粘贴，配置文件必须是双引号）

- 重启 Docker 让配置生效

```bash
sudo systemctl daemon-reload
sudo systemctl restart docker
```

至此，我们的 Docker 配置就完成了。

## Jenkins

首先我们需要创建数据目录，给 Jenkins 准备一个“家”。

```bash
# 创建目录
mkdir -p /data/jenkins_home

# 修改权限 (Jenkins 容器内部默认使用 uid 1000，需要把这个文件夹权限给它，否则启动会报错)
chown -R 1000:1000 /data/jenkins_home
```

然后安装并启动 Jenkins

```bash
docker run -d \
  --name jenkins \
  --restart always \
  -p 8080:8080 \
  -p 50000:50000 \
  -v /data/jenkins_home:/var/jenkins_home \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /usr/bin/docker:/usr/bin/docker \
  --env JAVA_OPTS="-Xmx1024m" \
  jenkins/jenkins:lts
```

**命令解析**

- `-p 8080:8080`: 将服务器的 8080 端口映射给 Jenkins。

- `-v ...`: 把刚才创建的目录挂载进去。

- `JAVA_OPTS`: 关键！限制 Jenkins 最大使用 1G 内存。

### 设置安全组

因为 Jenkins 默认跑在 8080 端口，和之前配置 https 443 一样，需要去阿里云控制台设置放行。

阿里云控制台 -> 安全组 -> 手动添加 -> 端口范围 8080

### 初始化 Jenkins

打开浏览器，输入 `http://你的服务器公网IP:8080`，进入 Jenkins 初始化页面。

回到服务器，输入 `docker ps` 查看 Jenkins 容器是否启动成功。

获取密码，输入 `docker logs jenkins` 查看日志，找到密码。

然后接下来的流程就和本地安装 Jenkins 一样了。

### 遇到的坑

#### Jenkins 版本过老的问题

使用了阿里云提供的加速器镜像，但下载的 Jenkins 版本太老了，2.319.1 版本是几年前的版本，导致很多插件都无法安装。后面又重新拉取 lts，导致 Docker 容器比较混乱而且问题还没解决。于是开始解决版本过老的问题。

##### 清理容器

**查看 Jenkins**

```bash
sudo docker ps -a | grep jenkins
```

**强制删除 Jenkins**

```bash
sudo docker rm -f jenkins
```

##### 清理镜像

**强制删除镜像**
```bash
sudo docker rmi -f jenkins/jenkins:lts
```

**验证镜像是否删除**
```bash
sudo docker images | grep jenkins
```

##### 清理残留数据

因为之前运行的是旧版本，初始化生成的数据文件格式太老，所以也要清空一下。

```bash
sudo rm -rf /data/jenkins_home
sudo mkdir -p /data/jenkins_home
sudo chown -R 1000:1000 /data/jenkins_home
```

##### 拉取最新版本

**重新拉取最新镜像**

```bash
sudo docker pull jenkins/jenkins:lts
```

**检查版本**
```bash
sudo docker inspect jenkins/jenkins:lts | grep JENKINS_VERSION
```

##### 镜像问题

尽管我使用了 `lts` 去拉取，但还是报错了。所以干脆放弃阿里云提供的镜像加速器，使用第三方代理镜像源。

1. 使用国内代理地址拉取

不要直接拉 `jenkins/jenkins`，我们在前面加上代理前缀 `docker.m.daocloud.io`。

```bash
sudo docker pull docker.m.daocloud.io/jenkins/jenkins:2.479.2
```

2. 给镜像改名

下载下来后，镜像的名字会很长，需要把它改回标准名字。

```bash
sudo docker tag docker.m.daocloud.io/jenkins/jenkins:2.479.2 jenkins/jenkins:2.479.2
```

3. 验证版本

```bash
sudo docker inspect jenkins/jenkins:2.479.2 | grep JENKINS_VERSION
```

到这里我们就能看到 `2.479.2` 版本号了。

#### 启动新容器

```bash
sudo docker run -d \
  --name jenkins \
  --restart always \
  -p 8080:8080 \
  -p 50000:50000 \
  -v /data/jenkins_home:/var/jenkins_home \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /usr/bin/docker:/usr/bin/docker \
  --env JAVA_OPTS="-Xmx1024m" \
  jenkins/jenkins:2.479.2
```
