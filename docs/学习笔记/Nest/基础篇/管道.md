# 管道

管道（Pipes）是 NestJS 中用于处理输入和输出的组件。它们可以用于转换、验证和格式化数据。

管道设计的典型应用场景：对请求参数进行有效的验证。

虽然可以在路由内部进行验证，但是这违反了单一职责原则；
另一种虽然可以使用中间件验证，但是中间件无法访问上下文；
这就是管道存在的意义。

## 内置管道

NestJS 提供了一些内置管道，用于处理常见的数据转换和验证。

- `ValidationPipe`：用于验证请求参数。
- `ParseIntPipe`：将字符串转换为整数。
- `ParseBoolPipe`：将字符串转换为布尔值。
- `ParseArrayPipe`：将字符串转换为数组。
- `ParseDatePipe`：将字符串转换为日期。
- `ParseEnumPipe`：将字符串转换为枚举值。
- `ParseFloatPipe`：将字符串转换为浮点数。
- `ParseUUIDPipe`：将字符串转换为 UUID。

## 绑定管道

使用管道，需要将管道类的实例绑定到适当的上下文中。绑定方式按照范围来区分，一共有四种。

- 参数级别：在控制器方法的参数上使用 `@Param()` 装饰器。

```ts
@Get(':id')
findById(@Param('id', ParseIntPipe) id: number) {
  return this.service.findById(id);
}
```

- 方法级别：在控制器方法上使用 `@UsePipes()` 装饰器。

```ts
@Post()
@UsePipes(new ValidationPipe())
create(@Body() createCatDto: CreateCatDto) {
  return this.catsService.create(createCatDto);
}
```

- 控制器级别：在控制器类上使用 `@UsePipes()` 装饰器。

```ts
@Controller('cats')
@UsePipes(new ValidationPipe())
export class CatsController {
  // ...
}
```

- 全局级别：在 AppModule 中使用 `useGlobalPipes()` 装饰器。

```ts
app.useGlobalPipes(new ValidationPipe({
  transform: true,
  whitelist: true,
  forbidNonWhitelisted: true,
  stopAtFirstError: true,
}));
```

## 自定义管道

自定义管道需要实现 `PipeTransform` 接口，并实现 `transform(value: any, metadata: ArgumentMetadata)` 方法。

```ts
import { PipeTransform, Injectable, ArgumentMetadata } from '@nestjs/common';

@Injectable()
export class ValidationPipe implements PipeTransform {
  transform(value: any, metadata: ArgumentMetadata) {
    return value;
  }
}
```

transform 方法接收两个参数：

- **value**：要转换的值
- **metadata**：参数的元数据

transform 方法返回一个值，这个值将被赋值给控制器方法的参数。


## 管道使用