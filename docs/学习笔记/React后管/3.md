# （三）：Redux 状态管理

## 概述

因为后管需要保存登录、菜单栏、主题等状态，所以我引入了`redux`作为状态管理工具。

关于 React 状态管理工具的选择，可以参考我另一篇[React状态管理方案](../React/status.md)

## 一. 安装依赖
```bash

npm install @reduxjs/toolkit --save
# 绑定库
npm install react-redux --save
# 持久化
npm install redux-persist --save
# 只安装开发环境依赖
npm install @types/redux-persist --save-dev
```

## 二. 创建目录

我们根据负责功能的不同，对状态进行了模块划分。例如用户信息、token等存放在`user.ts`，用户权限、菜单列表权限、按钮权限存放在`auth.ts`,`global.ts`则是全局状态，如主题颜色、按钮大小、页面布局。

```bash
src/redux/
│  index.ts                # Redux 主入口文件
│  
├─interface               # 类型定义文件夹
│      index.ts           # 公共类型定义
│      
└─modules                 # 状态模块文件夹
        auth.ts           # 认证相关状态
        global.ts         # 全局状态
        tabs.ts           # 标签页状态
        user.ts           # 用户状态
```

## 三. 类型定义

因为目前主要使用到用户状态，所以这里暂时只定义了用户状态接口。

```typescript
// src/redux/interface/index.ts

/* 全局状态接口 */
export interface GlobalState {
}

/* 标签类别接口 */
export interface TabsListProp {
}

/* 标签页状态接口 */
export interface TabsState {
}

/* 用户状态接口 */
export interface UserState {
  token: string;
  userInfo: { name: string };
}

/* 认证状态接口 */
export interface AuthState {
}
```

## 四. 状态模块
1. **全局状态模块**
```typescript
// src/redux/modules/global.ts
import { createSlice } from "@reduxjs/toolkit";
import { GlobalState } from "@/redux/interface";

const globalState: GlobalState = {
};

const globalSlice = createSlice({
  name: 'admin-global',
  initialState: globalState,
  reducers: {
    setGlobalState: (state, action) => {}
  }
})

export const { setGlobalState } = globalSlice.actions;
export default globalSlice.reducer;

```

2. **用户状态模块**
```typescript
// src/redux/modules/user.ts
import { createSlice, PayloadAction } from "@reduxjs/toolkit";
import { UserState } from "@/redux/interface";

const userState: UserState = {
  token: "",
  userInfo: {
    name: "Admin"
  },
}

const userSlice = createSlice({
  name: 'admin-user',
  initialState: userState,
  reducers: {
    setToken: (state, { payload }: PayloadAction<string>) => {
      state.token = payload;
    },
    setUserInfo: (state, { payload }: PayloadAction<{ name: string }>) => {
      state.userInfo = payload;
    },
  }
})

export const { setToken, setUserInfo } = userSlice.actions;
export default userSlice.reducer;
```

3. **认证状态模块**
```typescript
import { createSlice } from "@reduxjs/toolkit";
import { AuthState } from "@/redux/interface";

const authState: AuthState = {

};

const authSlice = createSlice({
  name: 'admin-auth',
  initialState: authState,
  reducers: {
    setAuthMenuList: (state, action) => {
    },
  },
})

export const { setAuthMenuList } = authSlice.actions;
export default authSlice.reducer;
```

4. **标签页状态模块**
```typescript
import { createSlice } from "@reduxjs/toolkit";
import { TabsState } from "@/redux/interface";


const tabsState: TabsState = {

}

const tabsSlice = createSlice({
  name: 'admin-tabs',
  initialState: tabsState,
  reducers: {
    setTabsState: (state, action) => {
    },
  },
})

export const { setTabsState } = tabsSlice.actions;
export default tabsSlice.reducer;
```

## 五. 配置 Store

1. **redux 基础配置**
```typescript
// src/redux/index.ts
import { configureStore } from "@reduxjs/toolkit";
import { TypedUseSelectorHook, useDispatch as useReduxDispatch, useSelector as useReduxSelector } from "react-redux";
import global from "./modules/global";
import user from "./modules/user";
import auth from "./modules/auth";
import tabs from "./modules/tabs";

// redux store
export const store = configureStore({
  reducer: {
    global,
    user,
    auth,
    tabs,
  },
});

// redux hooks
export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
// 自定义 hooks
export const useSelector: TypedUseSelectorHook<RootState> = useReduxSelector;
export const useDispatch = () => useReduxDispatch<AppDispatch>();
```

2. **持久化**
因为 redux store状态会随着页面刷新而丢失，所以需要 redux-persist 插件库来实现数据持久化。让我们来修改index.ts文件。

```typescript
// src/redux/index.ts
import { configureStore,combineReducers } from "@reduxjs/toolkit";
import { TypedUseSelectorHook, useDispatch as useReduxDispatch, useSelector as useReduxSelector } from "react-redux";
import { persistStore, persistReducer } from "redux-persist";
import storage from "redux-persist/lib/storage";

import global from "./modules/global";
import user from "./modules/user";
import auth from "./modules/auth";
import tabs from "./modules/tabs";

// 创建并合并 reducer
const reducer = combineReducers({
  global,
  user,
  auth,
  tabs,
});

// 持久化配置
const persistConfig = {
  key: 'redux-state',
  storage,
  blacklist: ["auth"]
}

// 包装 reducer
const persistReducerConfig = persistReducer(persistConfig, reducer);

// store
const store = configureStore({
  reducer: persistReducerConfig,
  middleware: (getDefaultMiddleware) => getDefaultMiddleware({
    serializableCheck: false,
  }),
  // 开启调试
  devTools: true,
});

// 持久化 store
export const persistor = persistStore(store);

// redux hooks
export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
export const useSelector: TypedUseSelectorHook<RootState> = useReduxSelector;
export const useDispatch = () => useReduxDispatch<AppDispatch>();
```

## 六. 在组件中使用

1. **redux 注入**
```typescript
// src/main.tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import { Provider } from 'react-redux';
import { PersistGate } from 'redux-persist/integration/react';
import { store, persistor } from './redux';
import App from './App';

ReactDOM.createRoot(document.getElementById('root') as HTMLElement).render(
  <Provider store={store}>
    <PersistGate persistor={persistor}>
      <React.StrictMode>
        <App />
      </React.StrictMode>
    </PersistGate>
  </Provider>
)
```

2. **在组件中使用**
```typescript
// src/App.tsx
import React from 'react';
import { ConfigProvider } from 'antd';
import zhCN from 'antd/locale/zh_CN';
import { useSelector } from '@/redux';

import Login from '@/views/login';

const App: React.FC = () => {
  const token = useSelector((state) => state.user.token);
  console.log('token-----------------', token);
  return (
    <ConfigProvider locale={zhCN}>
      <Login />
    </ConfigProvider>
  )
}

export default App;
```

## 七.总结

至此，后管的状态管理就完成了。因为采用了`Redux Toolkit`来编写`Redux`逻辑的方法，大大减少了工作量。我们使用了`redux-persist`实现状态持久化，避免页面刷新状态丢失的问题，
同时按照功能对模块进行划分，实现模块化的状态管理（global、user、auth、tabs）。

## 参考文献

1. [Redux 中文官网](https://cn.redux.js.org/)
2. [Redux 持久化](https://github.com/rt2zz/redux-persist)