# 雅虎35条军规

## 前言

前端性能优化是现代Web开发中至关重要的一环，直接影响用户体验、搜索引擎排名和商业价值。雅虎（Yahoo）开发者网络在2007年提出的35条前端性能优化规则，至今仍是业界公认的性能优化黄金标准。

![雅虎35条军规](/public/assets/yahu_1.png)

本文档整理了完整的35条军规，按以下7个类别系统归纳：

| 类别 | 规则数量 | 主要关注点 |
|------|----------|------------|
| **页面内容** | 10条 | HTTP请求、DNS、重定向、缓存等 |
| **服务器** | 7条 | CDN、压缩、缓存头、ETag等 |
| **Cookie** | 2条 | Cookie大小和域名策略 |
| **CSS** | 4条 | 样式表位置和优化 |
| **JavaScript** | 6条 | 脚本位置、压缩和DOM操作 |
| **图片** | 4条 | 图片优化和Sprite技术 |
| **移动端** | 2条 | 移动设备特殊考虑 |

接下来将详细介绍每个类别的具体规则和现代化实践方案。

---

## 页面内容

### 1. 减少HTTP请求

Web 前端 80% 的响应时间花在图片、样式、脚本等资源下载上。减少HTTP请求是提高页面加载速度的重要手段。减少HTTP请求可以通过以下几种方式：

- 合并JS/CSS文件。服务器端（CDN）自动合并，基于Node.js的文件合并工具，通过把所有脚本放在一个文件中的方式来减少请求数。
- 使用CSS Sprite雪碧图将背景图片合并成一个文件，通过background-image 和 background-position 控制显示
- 行内图片（Base64编码）。使用Data URI scheme将图片嵌入HTML或者CSS中；或者将CSS、JS、图片直接嵌入HTML中，会增加文件大小，也可能产生浏览器兼容及其他性能问题。

### 2. 减少DNS查询

用户输入URL后，浏览器首先要查询域名（hostname）对应服务器的IP地址，一般需要耗费20-120毫秒时间。DNS查询完成之前，浏览器无法从服务器下载任何数据。

基于性能考虑，ISP、局域网、操作系统、浏览器都会有相应的 DNS 缓存机制。

**DNS缓存机制：**

- IE缓存30分钟，可通过注册表中DnsCacheTimeout项设置
- Firefox缓存1分钟，通过network.dnsCacheExpiration配置
- Chrome等现代浏览器也有相应的DNS缓存策略

另外需要注意的是这里有一个矛盾，减少不同的域名可减少 DNS 查找，同时也减少了页面下载资源文件的并发量。也就是说，虽然避免 DNS 查找削减了响应时间，但是减少并行下载数量却增加了响应时间。原则是把组件分散在 2~4 个域名下，控制好数量，这是同时减少 DNS 查找和允许并发下载的折中方案。

```注解
为什么通过减少DNS查询能够优化？
1. 时间开销
每次DNS查询需要消耗20-120毫秒时间，而查询未完成前会阻塞浏览器下载资源。多个域名=多次DNS查询=累积延迟。这也是为什么2～4个域名是最佳实践，过少域名DNS查询次数虽然减少了，但并发下载受限，而过多域名DNS查询开销过大，并发下载多。

2. 网络开销
用户请求 → 本地DNS缓存 → 递归DNS服务器 → 根域名服务器 → 顶级域名服务器 → 权威域名服务器
每一个环节都网络延迟，影响整体性能。

3. 浏览器行为
浏览器必须先完成DNS解析才能建立TCP连接，而解析过程遇到新域名就要暂停等待DNS解析。

具体场景：
假设页面有10个资源分布在5个不同域名：
 - 没有DNS缓存时：5 × 80ms(平均DNS查询) = 400ms 额外延迟
 - 有DNS缓存时：第一次访问后续页面几乎无DNS开销
这就是为什么DNS查询优化对首次访问和缓存过期后的访问影响最大的原因！
所以减少DNS查询本质上是在减少这种串行阻塞带来的时间开销。
```

```注解
DNS查询优化具体方法

1. DNS预解析设置
<!-- 预解析即将用到的域名 -->
<link rel="dns-prefetch" href="//example.com">

<!-- 对于HTTPS站点，还可以预连接 -->
<link rel="preconnect" href="https://fonts.googleapis.com">

2. 服务器DNS优化
设置合理的TTL值

3. CDN配置优化
将静态资源分布到少数几个CDN域名，不同资源分散在不同域名下

```

### 3. 避免重定向

HTTP重定向通过301/302状态码实现。下面是一个有301状态码的HTTP头

```text
HTTP/1.1 301 Moved Permanently 
Location: http://example.com/newuri
Content-Type: text/html
```

浏览器会自动跳转到Location域指明的URL。重定向需要的所有信息都在HTTP头部，而响应体一般是空的。其实额外的HTTP头，比如Expires和Cache-Control也表示重定向。除此之外还有别的跳转方式：refresh元标签和JavaScript，但如果你必须得做重定向，最好用标准的3xxHTTP状态码，主要是为了让返回按钮能正常使用。

牢记重定向会拖慢用户体验，在用户和HTML文档之间插入重定向会延迟页面上的所有东西，页面无法渲染，组件也无法开始下载，直到HTML文档被送达浏览器。

有一种常见的极其浪费资源的重定向，而且web开发人员一般都意识不到这一点，就是URL尾部缺少一个斜线的时候。例如，跳转到`http://astrology.yahoo.com/astrology`会返回一个重定向到`http://astrology.yahoo.com/astrology/`的301响应（注意添在尾部的斜线）。在Apache中可以用Alias，mod_rewrite或者DirectorySlash指令来取消不必要的重定向。

重定向最常见的用途是把旧站点连接到新的站点，还可以连接同一站点的不同部分，针对用户的不同情况（浏览器类型，用户帐号类型等等）做一些处理。用重定向来连接两个网站是最简单的，只需要少量的额外代码。虽然在这些时候使用重定向减少了开发人员的开发复杂度，但降低了用户体验。一种替代方案是用Alias和mod_rewrite，前提是两个代码路径都在相同的服务器上。如果是因为域名变化而使用了重定向，就可以创建一条CNAME（创建一个指向另一个域名的DNS记录作为别名）结合Alias或者mod_rewrite指令。

```注解
Apache是传统Web服务器的标配，而我们现在更多是使用Nginx，Node.js服务器等。

需要手动配置Apache的配置文件，添加以下内容：
<VirtualHost *:80>
    DocumentRoot /var/www/html
    DirectoryIndex index.html
    # 处理路由重定向等...
</VirtualHost>

雅虎35条军规写于2007年，那时前端工程化还不发达，需要更多地考虑服务器配置。

现在我们可以忽视掉这个优化方法。
```