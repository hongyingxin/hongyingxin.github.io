# 2026年2月

## 2月24日

**服务器故障总结**

早上发了一次版本，然后我的阿里云服务器ECS奔溃了，花了半天的时间才解决掉，这里做一次总结。

**问题起因**

Jenkins发布触发内存崩溃。在仅有2GB内存的环境下，Jenkins执行了一次代码构建任务。Java进程瞬间耗尽物理内存，触发了Linux内核的OOM Killer机制，强制杀死了Java进程。由于内存极度匮乏，负责远程连接（SSH/VNC）的服务停止响应，呆滞实例出现“死机”假象。

**失败方案复盘**

使用了阿里云的诊断，显示Linux OOM内存溢出

1. 尝试使用Workbench连接服务器，发现无法连接。

2. 由于SSH无法正常连接，于是使用阿里云控制台的VNC(救援连接)，发现也无法连接。

3. 强制重启服务器，执行了上面两个步骤，还是不行。

4. 使用阿里云控制台左侧菜单的“云助手”服务，能执行命令，关闭了宝塔服务和Jenkins服务，并开启了Swap虚拟内存。

5. 尝试重启并再一次执行步骤1和2，发现还是连接不上。

6. 由于花费时间比较多和多次尝试无果后，采用阿里云ECS升降配方法，将服务器升级到4GB内存，发现还是不行。到这里排除了内存不够的问题。

7. 再一次使用阿里云的诊断，发现遗漏了一个点，防火墙处于开启状态（显示橙色警告），于是在云助手上面关闭了防火墙，遂成功访问服务器。现在的情况很可能是：系统其实已经启动了，但因为防火墙（iptables/firewalld）或安全组配置，把所有的访问请求（SSH、宝塔、Jenkins）全挡在了门外。当系统在 OOM 崩溃边缘反复横跳时，防火墙规则有时会因为初始化脚本执行不全，导致只开启了默认的“拒绝所有”规则。

**表格**

| 尝试方案 | 结果 | 失败原因深度分析 |
| :--- | :--- | :--- |
| VNC 连接 | 无效 | 系统内存被榨干，连显示登录界面的进程（getty）都无法启动，导致屏幕黑屏或无响应。 |
| 云助手杀进程 | 部分无效 | 报错 No such process。因为进程在指令到达前就已经崩溃或被内核先行杀掉，系统处于极度不稳定的状态。 |
| Workbench 登录 | 无效 | 防火墙规则因异常重启未完全加载，或默认处于“闭锁”状态，拦截了 22 端口。 |
| 初始尝试重启 | 无效 | 虽然重启释放了内存，但由于 Jenkins 或宝塔插件可能存在自启动配置，开机瞬间再次抢占内存，导致系统进入“启动-崩溃”死循环。 |
| 简单命令重启网络 | 报错 | 提示 Unit network.service not found。原因在于新版 Linux 系统（如 Alibaba Cloud Linux 3）已更换网络管理服务名称。 |

**转折点**

清理防火墙：使用 iptables -F 强制拆除所有连接屏障，解决了诊断报告中提到的“防火墙阻断”问题。

**最终状态与后续**

当前状态：实例已降配回 2GB，宝塔面板已手动恢复，Swap 已设置。

潜在风险：2GB 内存仍然无法支撑下一次 Jenkins 发布。 诊断报告显示的硬件故障虽然是旧闻，但 OOM 风险依然是现在的核心威胁

**诊断报告图**

![image.png](/public/assets/随笔/Snipaste_2026-02-24_14-14-37.png)

**优化**

1. 虽然我们设置了Swap虚拟内存，但是治标不治本，需要限制Jenkins的内存使用为1024MB，防止内存溢出。

2. 限制构建历史，Jenkins每一次构建完成后，会清理构建历史，防止构建历史过多，占用过多磁盘空间。我们将配置修改为“丢弃旧的构建”，保持构建天数设定为7天。

## 2月10日

**自动化部署总结**

需要通过Webhooks将Github仓库与Jenkins关联起来。当我们git push时，Github会通知Jenkins自动触发。

第一步：在Jenkins中开启触发器

- 进入项目配置
- 找到“构建触发器(Build Triggers)选项卡”
- 勾选“Github hook trigger for GITScm polling”

第二步：在Github中配置Webhook

- 打开我们的仓库项目地址，点击右上角的Setting -> 左侧菜单Webhooks
- 点击 Add webhook
- Payload URL填写我们的Jenkins域名。格式如下：http://你的服务器IP:端口/github-webhook/
- Content type选择“application/json”，Which event选择“Just the push event”，点击“Add webhook”

至此就完成了配置。但是我们的项目分为web和api，我们想修改那一部分就部署那一部分，按需部署。

我们可以通过Jenkins的git diff功能来实现按需部署。逻辑是：获取当前提交（Current Commint）和上一次提交（Last Stable Commit）之间的差异文件列表。如果差异路径包含apps/web，就设置web为待部署，如果包含apps/api，就部署api。

重点逻辑在Build Controls这一阶段

- git diff --name-only HEAD~- HEAD 这是识别改动的关键，它会列出本次推送中所有发生变化的文件路径
- when 将自动识别和手动选择结合在一起

## 2月9日

记录一下最近部署Jenkins的一些问题。

由于使用了宝塔系统，经常发生一个权限问题。比如Jenkins容器内部默认使用 uid 1000，需要把这个文件夹权限给它，否则在删除文件时会报错。

AI工具项目采用了`Monorepo`结构，前端React位于`apps/web`，后端Nest位于`apps/api`。

因为`.env`环境配置文件忽略上传到仓库，所以需要手动在后端构建打包对应的目录下创建这个文件。

前后端同时使用同一个域名，`nginx`使用`location /api/`进行转发。

因为不想每次更新后端代码都需要重启服务器，所以使用了`ecosystem.config.js`来管理进程。这里需要注释即使是TypeScript项目，也需要是`javascript`文件。

目前有一个地方还没搞懂，`node_modules`需要我手动在`dist`目录下创建，而不是有构建打包时完成。这个后续需要在研究下。

