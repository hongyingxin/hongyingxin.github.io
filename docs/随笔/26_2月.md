# 2026年2月

## 2月9日

记录一下最近部署Jenkins的一些问题。

由于使用了宝塔系统，经常发生一个权限问题。比如Jenkins容器内部默认使用 uid 1000，需要把这个文件夹权限给它，否则在删除文件时会报错。

AI工具项目采用了`Monorepo`结构，前端React位于`apps/web`，后端Nest位于`apps/api`。

因为`.env`环境配置文件忽略上传到仓库，所以需要手动在后端构建打包对应的目录下创建这个文件。

前后端同时使用同一个域名，`nginx`使用`location /api/`进行转发。

因为不想每次更新后端代码都需要重启服务器，所以使用了`ecosystem.config.js`来管理进程。这里需要注释即使是TypeScript项目，也需要是`javascript`文件。

目前有一个地方还没搞懂，`node_modules`需要我手动在`dist`目录下创建，而不是有构建打包时完成。这个后续需要在研究下。

## 2月10日

**自动化部署总结**

需要通过Webhooks将Github仓库与Jenkins关联起来。当我们git push时，Github会通知Jenkins自动触发。

第一步：在Jenkins中开启触发器

- 进入项目配置
- 找到“构建触发器(Build Triggers)选项卡”
- 勾选“Github hook trigger for GITScm polling”

第二步：在Github中配置Webhook

- 打开我们的仓库项目地址，点击右上角的Setting -> 左侧菜单Webhooks
- 点击 Add webhook
- Payload URL填写我们的Jenkins域名。格式如下：http://你的服务器IP:端口/github-webhook/
- Content type选择“application/json”，Which event选择“Just the push event”，点击“Add webhook”

至此就完成了配置。但是我们的项目分为web和api，我们想修改那一部分就部署那一部分，按需部署。

我们可以通过Jenkins的git diff功能来实现按需部署。逻辑是：获取当前提交（Current Commint）和上一次提交（Last Stable Commit）之间的差异文件列表。如果差异路径包含apps/web，就设置web为待部署，如果包含apps/api，就部署api。

重点逻辑在Build Controls这一阶段

- git diff --name-only HEAD~- HEAD 这是识别改动的关键，它会列出本次推送中所有发生变化的文件路径
- when 将自动识别和手动选择结合在一起